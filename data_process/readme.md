# 空气质量数据提取与整合脚本

## 概述

这是一个Python脚本，旨在自动化从多个CSV文件中提取、处理和整合特定城市（默认为“南京”）的每小时空气质量数据。脚本会扫描指定文件夹及其子文件夹中符合特定文件名模式（默认为 `china_cities_*.csv`）的CSV文件，提取15种预定义的空气质量指标，并将整合后的数据输出到一个结构化的Excel（.xlsx）文件中。

用户可以自定义目标城市、输入文件夹、输出文件名和Excel工作表名。

## 主要功能

* **用户可配置的目标城市**：允许用户在脚本运行时输入目标城市名称（默认为“南京”）。
* **递归文件搜索**：自动扫描指定文件夹及其所有子文件夹，查找匹配文件名模式的CSV文件。
* **特定指标提取**：从CSV文件中提取15种空气质量指标（AQI, PM2.5, PM10, SO2, NO2, O3, CO 及其相关的24小时或8小时平均值）。
* **数据透视与整合**：将提取的长格式数据转换为宽格式，其中每行代表一个小时的记录，各项指标作为列。合并来自所有源文件的数据。
* **Excel输出**：将最终处理过的数据保存为 `.xlsx` 格式的Excel文件，工作表名称根据目标城市动态生成。
* **用户友好的交互界面**：通过简单的图形界面（Tkinter）提示用户选择文件夹、输入城市名称和选择保存路径。
* **错误处理**：包含对文件未找到、列缺失、数据转换错误和文件保存权限等问题的基本错误处理和提示。

## 先决条件

* **Python**: 版本 3.7 或更高版本。
* **Python库**:
    * `pandas`: 用于数据处理和分析。
    * `openpyxl`: 用于读写Excel 2010 xlsx/xlsm/xltx/xltm 文件 (pandas写入Excel时需要)。
    * `tkinter`: Python内置的GUI库，用于文件和文本输入对话框 (通常随Python标准安装版提供)。

## 安装依赖

在运行脚本之前，您需要安装 `pandas` 和 `openpyxl`。您可以使用pip（Python的包安装器）来安装它们。打开您的命令行终端并运行以下命令：

```bash
pip install pandas openpyxl
```tkinter` 通常是Python标准库的一部分，无需额外安装。

## 如何运行脚本

1.  **保存脚本**：将提供的Python代码保存为一个 `.py` 文件（例如，`extract_aqi_data.py`）。
2.  **准备数据**：
    * 将所有源CSV文件（例如，`china_cities_20250101.csv`）放置在一个主文件夹中。脚本也会搜索该主文件夹下的所有子文件夹。
    * 确保CSV文件包含名为 `date`, `hour`, `type` 的列，以及一个与您目标城市名称相匹配的列（例如，“南京”）。
3.  **执行脚本**：
    * 打开命令行终端。
    * 导航到脚本保存的目录。
    * 运行脚本：
        ```bash
        python extract_aqi_data.py
        ```
4.  **用户交互**：
    * 脚本会首先弹出一个对话框，要求您**输入目标城市名称**（默认为“南京”）。输入城市名后点击“确定”，或直接点击“确定”使用默认值，或点击“取消”也使用默认值。
    * 接下来，会弹出一个对话框，提示您**选择包含CSV文件的文件夹**。
    * 然后，会弹出一个对话框，让您**选择保存Excel文件的位置和名称**。默认的文件名会根据您输入（或默认）的城市名生成（例如，`南京_AQI_Data.xlsx`）。
5.  **处理与输出**：
    * 脚本会在命令行终端打印处理进度，包括找到的文件数量、正在处理的文件名以及每个文件提取到的记录数。
    * 处理完成后，如果成功，会弹出一个成功消息框，告知您数据已保存。如果发生错误（例如，权限问题），会弹出相应的错误提示。
    * 最终的Excel文件将包含一个以目标城市命名的工作表（例如，“南京_AQI_Data”）。

## 脚本内部配置参数

脚本顶部有一些可配置的参数，如果需要，您可以直接修改它们：

* `DEFAULT_TARGET_CITY`: 字符串，用户未输入城市时使用的默认城市名称（例如 `"南京"`）。
* `TARGET_METRICS`: 列表，包含要提取的15个空气质量指标的名称。
* `FILE_PATTERN`: 字符串，用于匹配CSV文件名的模式（例如 `"china_cities_*.csv"`）。
* `OUTPUT_SHEET_NAME_TEMPLATE`: 字符串模板，用于生成Excel工作表的名称，`{}` 会被实际的城市名替换（例如 `"{}_AQI_Data"`）。

## CSV文件结构要求

脚本期望CSV文件具有以下结构特点：

* 包含名为 `date` 的列（日期，格式通常为YYYYMMDD）。
* 包含名为 `hour` 的列（小时，0-23）。
* 包含名为 `type` 的列，其值对应 `TARGET_METRICS` 列表中的指标名称。
* 包含一个与 `target_city_name`（用户输入或默认的城市）同名的列，该列包含对应指标的数值。

## 错误处理和日志

* 脚本会在命令行打印其操作的日志信息，包括正在处理的文件和遇到的任何警告或错误。
* 对于常见问题，如文件未找到、列缺失或保存文件时的权限问题，脚本会尝试提供有用的错误消息。

## 贡献

如果您发现任何问题或有改进建议，请随时提出。
